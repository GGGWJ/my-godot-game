# 学习报告：表现中介架构 (Visual Bridge)

## 1. 核心问题回顾 (Problem Review)
在项目初期及中期快速迭代中，我们遇到了以下几个严重的架构瓶颈：
*   **资源共享陷阱 (Material Sharing)**: 多个敌人共享同一个 ShaderMaterial，导致一名敌人受击时全场怪物同时闪红。
*   **坐标系混淆 (Physics Space)**: 技能检测圆心使用了局部坐标而非 `global_position`，导致检测范围随角色移动偏离。
*   **硬编码耦合 (Strong Coupling)**: 逻辑层直接通过 `$` 或 `get_node` 访问视觉节点（如 `Weapon`），一旦场景层级调整，程序立即崩溃。
*   **表现与速度绑定**: 角色翻转完全依赖属性 `velocity`，导致施法动作或静止转向时视觉无法响应输入。

## 2. 核心架构方案：表现中介 (Visual Bridge)
为了解决上述问题，我们将 `Entity` 彻底拆分为两个互不感知的层：

### 逻辑层 (Entity & Action)
*   **职责**: 负责数值计算（生命值、速度）、AI 决策、物理移动。
*   **原则**: **“不感知显示”**。不持有 Sprite 引用，不调用动画播放器。
*   **通信**: 状态变化时发出信号（如 `damaged`, `animation_requested`）。

### 表现层 (EntityVisual)
*   **职责**: 负责监听信号并触发视觉反馈（播放动画、震动、飘字、粒子特效）。
*   **原则**: 作为逻辑层的“消费者”。逻辑层不关心表现层内部的节点结构。
*   **修复关键点**: 在 `_setup_visual` 中调用 `material.duplicate()`，从根源上消除资源共享 Bug。

## 3. 设计原则 (Design Principles)

*   **隔离优于共享**: 动态生成的实体必须在 Ready 阶段对资源（尤其是材质）进行物理复制，确保个体状态独立。
*   **世界坐标优先**: 跨实体的物理射线检测、区域检测必须统一使用 `global_position` 处理。
*   **逻辑状态化 (Statefulness)**: 引入 `facing_direction` 逻辑状态。视觉翻转应基于此状态而非仅仅基于瞬间速度，以支持动态操作（如鼠标跟随）。
*   **标准化外部访问 (API Proxy)**: 表现层通过定义 `get_weapon_node()` 等标准化方法对外暴露组件，而不是让外部脚本伸手进节点树里乱翻。

## 4. 协作开发建议
*   **向下调用，向上信号**: 父节点通过方法调用子节点，子节点永远只通过信号通知父节点发生了什么。
*   **路径隔离**: 技能 Manifest（表现体）绝对不应持有对 Caster 内部的具体路径引用，统一通过 `Caster.get_visual()` 处理。
