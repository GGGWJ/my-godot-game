# 学习报告：战斗交互系统 (Hitbox & Hurtbox)

## 1. 核心理念：物理握手协议
传统的战斗逻辑通常是“主动发现并修改”，即 A 检查 B 是否有 `take_damage` 方法。这种方式在逻辑复杂后会导致严重的硬编码耦合。
**Hitbox & Hurtbox 系统** 将战斗转化为一种基于物理区域的“握手协议”。

## 2. 核心组件分工

### DamageData (战斗载荷)
*   **路径**: `src/framework/stats/damage_data.gd`
*   **职责**: 一个轻量级的数据类，包含了伤害值、来源、方向、击退力等所有战斗信息。
*   **作用**: 作为 Hitbox 和 Hurtbox 之间唯一的“共同语言”。

### Hitbox (攻击盒)
*   **节点类型**: `Area2D`
*   **职责**: “我带有伤害”。挂载在子弹、武器挥击等产生伤害的区域。
*   **逻辑**: 当进入一个 Hurtbox 时，自动打包 `DamageData` 并触发对方的接收函数。

### Hurtbox (受击盒)
*   **节点类型**: `Area2D`
*   **职责**: “我可以被揍”。挂载在实体的受击区域。
*   **逻辑**: 
    1.  **过滤**: 检查阵营（防止自伤）和无敌状态。
    2.  **分发**: 将接收到的 `DamageData` 转化为具体的数值操作（如调用 `HealthComponent` 扣血）和物理反馈（如击退）。

## 3. 架构演进：逻辑与物理的分离

### 传统模式 (Logical Hit)
*   使用 `AbilityGetTargets` 寻找范围内实体。
*   直接调用 `entity.apply_damage()`。
*   *适用场景*: 地震、全屏闪电等非接触式技能。

### 新模式 (Physical Hit)
*   技能生成一个带有 `Hitbox` 的表现体（如挥砍特效）。
*   表现体在物理世界中物理性地“撞”到敌人的 `Hurtbox`。
*   *适用场景*: 近战挥砍、射击子弹、火球等。
*   *优势*: 伤害判定与动画帧完全同步，且自动处理复杂的重叠判定。

## 4. 协作守则
1.  **层级隔离**: 始终保持 `Hitbox` 和 `Hurtbox` 在不同的碰撞层（Collision Layer/Mask）。
2.  **阵营保护**: 在 Hurtbox 中统一处理 `team` 检查，不要分散在各个技能脚本中。
3.  **反馈统一**: 所有的受击视觉反馈（受击闪红、震屏）应通过监听 `Hurtbox.received_hit` 信号触发，保持表现层的被动性。

---
*最后更新日期: 2026年1月18日*
