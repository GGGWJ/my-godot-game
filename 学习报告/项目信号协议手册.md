# 项目信号协议 (Signal Protocol)

本文档记录了项目中所有的全局信号（EventBus）和关键模块信号，避免命名冲突和“野信号”泛滥。

## 1. 全局事件总线 (EventBus)
文件路径：`src/core/autoload/event_bus.gd`

| 信号名称 | 参数 | 触发时机 | 监听者 |
| :--- | :--- | :--- | :--- |
| `play_cast_ability` | `ability: Ability` | 某个组件请求释放技能时（通常是玩家输入） | Player, UI |
| `player_ready` | `player: Player` | 玩家实体 `_ready` 初始化完成时 | Enemy, UI (HUD) |
| `player_health_changed` | `curr: float, max: float` | 玩家血量变化时 | HUD (血条), ScreenEffects |
| `camera_shake_requested` | `intensity: float` | 需要震屏时（如爆炸、重击） | CameraController |

## 2. 实体层级信号 (Entity Signals)
文件路径：`src/framework/entities/entity.gd`

这些信号由 `Entity` 向上发出，通常被 `EntityVisual` 或 Gameplay 系统监听。

| 信号名称 | 参数 | 用途 |
| :--- | :--- | :--- |
| `health_changed` | `curr, max` | 血条更新 |
| `damaged` | `amount` | 弹出伤害数字 |
| `died` | `entity` | 掉落物品、播放死亡动画 |
| `fsm_state_changed` | `new_state, old_state` | **核心驱动**: 驱动动画切换、音效切换 |

## 3. 战斗组件信号 (Combat Signals)
文件路径：`src/framework/components/combat/`

| 组件 | 信号 | 用途 |
| :--- | :--- | :--- |
| `Hurtbox` | `received_hit(damage_data)` | 播放受击特效、音效 |
| `Hitbox` | `hit_hurtbox(hurtbox)` | 播放命中特效（如火花）、销毁子弹 |
| `HealthComponent` | `died` | 真正的数据死亡，触发实体 `die()` |

## 4. 最佳实践准则
1.  **禁止跨级连接**: 子节点不要直接 connect 爷爷节点的信号。尽量通过 `Entity` 中转。
2.  **状态驱动视觉**: 尽量减少 `play_anim("run")` 的直接调用。首选监听 `fsm_state_changed`，当状态变为 "run" 时自动播放。
3.  **参数标准化**: 所有的伤害传递必须使用 `DamageData` 对象，禁止传递游离的 `float`。

